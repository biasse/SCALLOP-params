from klpt import *
from id2iso import *
from param_loader import load

if __name__=="__main__":
    
    param_lvl = "2048"

    params = load('75-primes-' + param_lvl)

    p = params['p']
    F = params['F']
    f = params['f']
    D_com = params['D_com']
    D_chall = params['D_chall']
    T = params['T']
    B_2 = params['B_2']
    B_chall = params['B_chall']
    facToExt = params['facToExt']
    facToBasis = params['facToBasis']
    facToAction = params['facToAction']
    small_ns = params['small_ns']
    small_s = params['small_s']

    # Oops I fcked up in precomputing for 512
    #facToBasis[Integer(2)**256] = [P.xDBL().xDBL().xDBL() for P in facToBasis[Integer(2)**259]]
    #facToAction[Integer(2)**256] = facToAction[Integer(2)**259]

    B = QuaternionAlgebra(-1, -p)
    i, j, k = B.gens()
    O0 = B.quaternion_order([1, i, (i+j)/2, (1+k)/2])

    ### 512 ###
    #I = O0.left_ideal((Integer(1)/Integer(2) + Integer(8028170362878520627000397624849124892182804416632981394797083245489770480253778314941516911176802745559682787465824306790119665950954458423109837617464626788671289332024103172895239588435040315)*j + Integer(5517406830432160569531460434783887168508512136923704264395014092668084428703376490606065995099857645960283681480115728322350240403716673861139024369914489493617824498398267835375843424885744371)/Integer(2)*k, Integer(1)/Integer(2)*i + Integer(12559263776757650835333586527979651668129931543141805391191597038825242054633959978712546746135088882968796071885052394436683145813123728240242016740549303638376323965584247860375004143396377679)/Integer(2)*j + Integer(8028170362878520627000397624849124892182804416632981394797083245489770480253778314941516911176802745559682787465824306790119665950954458423109837617464626788671289332024103172895239588435040315)*k, Integer(9038335303594905702432523481381769418319221840032754827793305565746663241668668234659306370617473264464539876682584061379516693108420201050690520555231896565997074231991257847875423784141061025)*j, Integer(9038335303594905702432523481381769418319221840032754827793305565746663241668668234659306370617473264464539876682584061379516693108420201050690520555231896565997074231991257847875423784141061025)*k))
    #e = 256
    #delta = Integer(159552265354474160974185212535768133044337794207791175162387613622343972203672892620294385823603408615196894574815513736838239809843521949481306153521731911016128471720392737067923933657432024617399001841668116552111895154362008623304629452031945255102495907218)/Integer(9038335303594905702432523481381769418319221840032754827793305565746663241668668234659306370617473264464539876682584061379516693108420201050690520555231896565997074231991257847875423784141061025)*i + Integer(4902147998203463609140318443449451568899667218603278364071763525977316879466888129190741568857630859366516877631404224168670484233439)/Integer(549808088545802169163220059998624582926252705370476475637848044457656659938712373541945240502154425889132548817234649507275543645826026872116847498349322773005331519118581555533905335425)*j + Integer(1783766779885671839023099111918400074849355529222311908852243800862128393632296029189893648014519111591965727974458431623743887874422)/Integer(2265448505717903648678647719629633568480208600021494350448048777709962475776333040824260396756471632053613761796496696167081706043625485738879153547554205089925814009013648544638789612645)*k
    #omega = Integer(2310820388073888658175157102723307102542652012212569935585880870910116436225) - delta
    
    ### 1024 ###
    #I = O0.left_ideal((Integer(1)/Integer(2) + Integer(685007987407002328385657243320103317114507692539286019973979404696562077561845287517851438169205921643128283263047282449676994580335515837286045935409445563266189766896270322283618553453785413503026053008941)*j + Integer(339622259194838739769576394104774179369222497042180578849092505553706635091239698632368125210224223605737409434153645788235545862572169503978401359957725222863270532615665104120442395699141646241989356438805)/Integer(2)*k, Integer(1)/Integer(2)*i + Integer(1184726458466882292302821208958681168242462210075966352803615602016024949942781072437832740818306663546880857467395318464628923471991906839414666112879696222726971921532529517869735605685099989623317652873545)/Integer(2)*j + Integer(685007987407002328385657243320103317114507692539286019973979404696562077561845287517851438169205921643128283263047282449676994580335515837286045935409445563266189766896270322283618553453785413503026053008941)*k, Integer(762174358830860516036198801531727673805842353559073465826354053784865792517010385535100433014265443576309133450774482126432234667282038171696533736418710722795121227074097310995089000692120817932653504656175)*j, Integer(762174358830860516036198801531727673805842353559073465826354053784865792517010385535100433014265443576309133450774482126432234667282038171696533736418710722795121227074097310995089000692120817932653504656175)*k))
    #e = 518
    #delta = Integer(9606326337921206847938752593969970419136633589855810918422788159488757873099498049930964921611333196319529099574454436999312731782500515928142614952680748607954733962712409752928747365200187621269022899355581229637730676541138884421891907599597158372625349366357542367555115125368877715895311154324651689662847557618090043457299911794953302842862481)/Integer(762174358830860516036198801531727673805842353559073465826354053784865792517010385535100433014265443576309133450774482126432234667282038171696533736418710722795121227074097310995089000692120817932653504656175)*i + Integer(31532820412484549496770528269636797662904276836008793921008597228152532026126859825380363444457778970576206970784428987920681538210435390632681087323816696196259223294668683752212215939324)/Integer(152434871766172103207239760306345534761168470711814693165270810756973158503402077107020086602853088715261826690154896425286446933456407634339306747283742144559024245414819462199017800138424163586530700931235)*j - Integer(39830127181740430214048082814701718232352105340024973342555319105145974307097262053105000144370778586334286452924022230408579592869420623175179376180337798524873388783350137916426516953783)/Integer(762174358830860516036198801531727673805842353559073465826354053784865792517010385535100433014265443576309133450774482126432234667282038171696533736418710722795121227074097310995089000692120817932653504656175)*k
    #omega = Integer(107262463439540776796592199985616134275233279428307433766342950569669432214610248132438916680001426895938208196632896833496294702258913582339408834412325768) - delta


    ### 2048 ###    
    I = O0.left_ideal((Integer(1)/2 + Integer(10670488329653347564655103510838619352728510166943392707364878879931175598052529021650218885276585699435437212219291493746019259845627225768693311512799753521555930682051515436727812848641914788725698757935670566859771570435666079313403633588490372763763485333028783721376936279427939813257376855093736522119337197335550253264559541948364301991732279001987334469080814819134010022211834735565096237190724350585208686764147595819757764963)*j + Integer(45045020652618826646301316148869029943075218672657017809221291285785327870127652419763682830432979177517527535720129612569163951850429461133510822546391173114931397008406658300514370313017905627753566652494873444194081503335360397917516295297606558321582889256166436603750104227451950699580786523356229825691185763449044186373855345459533388607167005148496395409144714879329565247214906744356881023102044597987884844056157611276083462765)/Integer(2)*k, Integer(1)/Integer(2)*i + Integer(1780992229554643450951443420046575268198015560947051871417947570022864055507553725807785363859589948064689820217495640008065011913229205492015781684497244887814043935611318276576561075094257856883009402491291482859780419518787293137160883361502135684652929659273376705493689601161382055428044687060892387549666777671515526518864195084375483652152777053231867858672061637005830552044272461936077976370849738339636086543318315893053410985)/Integer(2)*j + Integer(10670488329653347564655103510838619352728510166943392707364878879931175598052529021650218885276585699435437212219291493746019259845627225768693311512799753521555930682051515436727812848641914788725698757935670566859771570435666079313403633588490372763763485333028783721376936279427939813257376855093736522119337197335550253264559541948364301991732279001987334469080814819134010022211834735565096237190724350585208686764147595819757764963)*k, Integer(23413006441086735048626379784457802605636617116802034840319619427904095962817603072785734097146284562791108677968812626288614481881829333312763302115444209001372720472008988288545465694056081742318288027493082463526930961427073845527338589329554347003117909457719906654621896914306666377504415605208561106620426270560279856446359770271954436129659891100864131633908388258167697899629589603146479499736447168163760465299737963584568436875)*j, Integer(23413006441086735048626379784457802605636617116802034840319619427904095962817603072785734097146284562791108677968812626288614481881829333312763302115444209001372720472008988288545465694056081742318288027493082463526930961427073845527338589329554347003117909457719906654621896914306666377504415605208561106620426270560279856446359770271954436129659891100864131633908388258167697899629589603146479499736447168163760465299737963584568436875)*k))    
    e = 1558
    delta = Integer(7493567072746351225553466299773431807303315713295230966212597627030559704249274318705730502971855417600233758125652262827295464388283683711762244547127213208965961197928074794681442889893062437253199709278459151916052719265815841308311980288797170515283831646977416338508064467278209946035671876778075849936918397669431944141961884343631004004882663472139709242936439986419069145710527183300945867951393158522794229429619936979251646399354308201196185751924856270965451923894120776851886195190438122723071626278206796563621756289668547551390007968867037077119349149688865363539281166906680129468579449334574532511178305529842116972700006213685122304279230341598802193928511921942688661661531132447625892396554747077947429393633896531836)/Integer(23413006441086735048626379784457802605636617116802034840319619427904095962817603072785734097146284562791108677968812626288614481881829333312763302115444209001372720472008988288545465694056081742318288027493082463526930961427073845527338589329554347003117909457719906654621896914306666377504415605208561106620426270560279856446359770271954436129659891100864131633908388258167697899629589603146479499736447168163760465299737963584568436875)*i + Integer(502349596284944674574059318177224168835350510094624245810712222367881303554246637375556218458776592628171210570839756816446570804691006947906354570960508737956009823399311751434685207868013588191797395605136711149583812960616854350653365474348825554947477764039398899414301907435281835906392594085532143913907483097223702734821966112564673089110969140897483971172175149644)/Integer(136546854699715598219032337704241697172231167391607819906800918134337013167804526129447607949997285526440432029678433652865683853158541587570427213223947796934492289808468132205088301951162521461046207841210057233411663963065779287477552791120953821497786192270841901581208391883513640553491474092138693649551956787450965832364387894158892112849035611354294646918662049153866374476596329298378558304822833628809147437084757609917875)*j + Integer(94154728340613286110567656096860911043269136510355743263590983274465500944937963736101253399044926746967696587782277061372124078762519534008867274747204022889425609049429086379069489692418616063459815370556592333039927079621712747587953066701232348744008841840396189638120452070510440082206623138941482322636451366387224497140895606909180213728832266481640364832279815423671)/Integer(43277276231213928001157818455559709067720179513497291756598187482262654275078748748217623100085553720501125097909080640089860410132771410929322185056273953791816488857687593879011951375334716714081863267085180154393587729070376793950718279721911916826465636705582082540890752152138015485220731248074974319076573513050424873283474621574777146265545085214166601911106078111215707762716431798792013862729107519711202338816521189620274375)*k
    omega = Integer(232007032965710912846367703956504941260215215003729495094661722648281996659142863001244325937120355060553599499871026534840874337439601632848341790459672367814467055645477907681036367113922466169885794792754630236311583884405452263614934606125854588876611014459926462737712151943041310401012083983874766372561029307398575844608398419218163193358634121266166606094294038855232462046735297798208979469175143424236638389444180471418676127269926132147456628294964441839616) - Integer(1235663578823509748696742143970670400718111116829586133108290973299097730767615645435043104063364231866394632519734062073682723607586977391799925214991496284160)*delta
    
    O_start = I.right_order()
    print(f"omega norm: {omega.reduced_norm()}")
    print(f"factored: {factor(omega.reduced_norm())}")
    assert delta in O_start
    assert delta/2 not in O_start
    assert omega in O_start
    assert omega/2 not in O_start

    I_omega_half1 = O_start*omega + O_start*2**e
    I_omega_half2 = O_start*omega.conjugate() + O_start*2**e

    print(factor(I_omega_half1.norm()))
    print(factor(I_omega_half2.norm()))
    E0 = EllipticCurve(F, [1,0])
    phi_start = IdealToIsogeny(O0, I, E0, facToBasis, facToAction)

    E_start = phi_start.codomain()

    K_1 = IdealToIsogenyGens(O0, pullback(I, I_omega_half1), facToBasis, facToAction)
    K_2 = IdealToIsogenyGens(O0, pullback(I, I_omega_half2), facToBasis, facToAction)

    print("Got the gens on E_0")
    print(K_1, K_2)

    K_1 = E0.lift_x(K_1[0][0].X)
    K_2 = E0.lift_x(K_2[0][0].X)
    K_1 = phi_start(K_1)
    K_2 = phi_start(K_2)

    print("All done!")
    print("Starting curve:")
    print(E_start)
    print("Effective orientation:")
    print(K_1) 
    print(K_2)